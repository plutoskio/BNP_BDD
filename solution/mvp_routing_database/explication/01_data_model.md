# Data Model (Detailed)

## Design intent

Single SQLite database with three domains:

1. Client/service-request domain (what AI can answer directly).
2. Operations domain (desks, agents, tickets, workloads).
3. Explainability/audit domain (routing trace, hops, messages).

## Core tables

### `desks`
- One row per operational desk.
- `specialty` is the semantic capability label for routing.

### `agents`
- Agent belongs to one desk (`desk_id` FK).
- No expertise score table by design (simplified MVP).
- `max_open_tickets` supports load-based routing.

### `clients`
- Synthetic client master.
- `primary_desk_id` gives default ownership context.

### `cash_accounts`
- Cash balances for direct AI responses.
- Enforces `available_cash + held_cash = cash_balance` with a check constraint.

### `positions`
- Client positions to answer portfolio/holding questions.

### `trades`
- Trade lifecycle table.
- Status values include `CONFIRMED`, `EXECUTED`, `FAILED`, `PENDING`, `CANCELLED`.
- Failing trades must include `fail_reason`.

### `intents`
- Canonical request categories (cash balance, trade status, failed trade investigation, etc.).

### `routing_rules`
- One routing policy per intent.
- `data_direct_available` controls AI direct-answer eligibility.
- `default_multi_desk` indicates whether intent usually needs coordination.
- `primary_desk_id` is the starting desk for assignment.

### `tickets`
- Main work item.
- Contains routing outcome flags (`automatable`, `requires_multi_desk`), ownership, status timestamps.
- Status/time consistency enforced with CHECK constraints.

### `ticket_assignments`
- Assignment history for ownership and contributors.
- Supports owner-change analysis without overwriting history.

### `ticket_desk_plan`
- Planned desk sequence for complex tickets.
- Typically generated by the future AI coordinator.

### `ticket_desk_hops`
- Actual desk transfers over time.
- Enables transfer count / ping-pong analysis.

### `routing_trace`
- Step-by-step decision path (tree nodes, decisions, rationales, actor type).
- Primary explainability table for management demos.

### `email_messages`
- Inbound/outbound communications linked to tickets.
- `is_automated` and `related_trace_id` connect messaging to routing logic.

## Views

### `v_agent_open_load`
- Computed workload per agent from active tickets.
- Active statuses: `OPEN`, `IN_PROGRESS`, `WAITING_CLIENT`, `ESCALATED`.
- Contains `available_slots` and `load_ratio` for assignment decisions.

### `v_ticket_decision_path`
- Ordered trace for each ticket.
- Simplifies debug/explanation without writing joins repeatedly.

## Integrity and indexing

- Foreign keys enabled (`PRAGMA foreign_keys = ON`).
- Status/flag values constrained with CHECK conditions.
- Indexes added on major join/filter keys (`ticket_id`, `owner_agent_id`, `status`, etc.).
